<?php if ($this->postData) { ?>
    <?php
    // check access and generate link for default/user/id
    if ($this->checkUserAccess('default' . Acl::RESOURCE_SEPARATOR . 'user', 'id')) {
        $defaultUserIDUrl = $this->url(
            array('module' => 'default', 'controller' => 'user', 'action' => 'id',
                'userID' => $this->escape($this->postData['User']['ID'])), 'defaultUserID'
        );
    } else {
        $defaultUserIDUrl = '#';
    }
    ?>

    <?php
    if ($this->postCommentData) {
        $commentsCount = count($this->postCommentData);
    } else {
        $commentsCount = 0;
    }
    ?>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="block block-default">
                <?php
                echo $this->BlockConfigMenu($this->t("Контент"))->postMenu(
                    $this->escape($this->postData['ID'])
                );
                ?>
                <div class="block-header block-header-info clearfix">
                    <div class="pull-right m-r-15 tooltip-field"
                         data-title="<?= $this->t('Просмотров'); ?>" data-placement="bottom">
                        <i class="fa fa-eye fa-lg"></i>
                        <?= $this->escape($this->postData['Views']); ?>
                    </div>
                    <div class="pull-right m-r-15 tooltip-field"
                         data-title="<?= $this->t('Комментарии'); ?>" data-placement="bottom">
                        <i class="fa fa-comments-o fa-lg"></i>
                        <?= $commentsCount; ?>
                    </div>
                    <div class="pull-left m-r-15 tooltip-field" data-title="<?= $this->t('Автор'); ?>"
                         data-placement="bottom">
                        <a href="<?= $defaultUserIDUrl; ?>" target="_blank">
                            <i class="fa fa-user fa-lg"></i>
                            <?= $this->escape($this->postData['User']['NickName']); ?>
                        </a>
                    </div>
                </div>
                <div class="block-body">
                    <?php if ($this->escape($this->postData['ImageUrl'])) { ?>
                        <div class="m-b-15 center-block text-center">
                            <a href="#" data-toggle="modal" data-target=".post-<?php print $this->postData['ID']; ?>"
                               title="<?= $this->escape($this->postData['Name']); ?>" class="">
                                <img class="img-thumbnail img-responsive"
                                     src="<?= $this->escape($this->postData['ImageUrl']); ?>"/>
                            </a>
                            <?= $this->modal(array(
                                'title' => $this->postData['Name'],
                                'class' => 'post-' . $this->postData['ID'],
                                'content' => '<img src="' . $this->escape($this->postData['ImageUrl']) . '" class="img-responsive img-rounded center-block" alt="">'
                            )); ?>
                        </div>
                    <?php } ?>
                    <div class="block-content-text">
                        <?php
                        echo $this->RenderContentTypeText(
                            $this->postData['Text'], $this->postData['ContentType']['Name']
                        );
                        ?>
                    </div>
                    <div class="button-like-wrapper">
                        <div id="vk-like-button" class="button-like">
                            <!-- VK Like -->
                            <script type="text/javascript" src="//vk.com/js/api/openapi.js?96"></script>
                            <script type="text/javascript">
                                VK.init({apiId: 3649896, onlyWidgets: true});
                            </script>
                            <div id="vk_like"></div>
                            <script type="text/javascript">
                                VK.Widgets.Like("vk_like", {type: "mini", height: 18});
                            </script>
                        </div>
                        <div class="fb-like-button button-like">
                            <!-- Facebook like-->
                            <div id="fb-root"></div>
                            <script>(function (d, s, id) {
                                    var js, fjs = d.getElementsByTagName(s)[0];
                                    if (d.getElementById(id))
                                        return;
                                    js = d.createElement(s);
                                    js.id = id;
                                    js.src = "//connect.facebook.net/ru_RU/all.js#xfbml=1";
                                    fjs.parentNode.insertBefore(js, fjs);
                                }(document, 'script', 'facebook-jssdk'));</script>
                            <div class="fb-like" data-href="<?= $this->url() ?>" data-width="450"
                                 data-layout="button_count" data-show-faces="true" data-send="false"></div>
                            <!-- Facebook like END-->
                        </div>
                        <div class="gp-like-button button-like">
                            <div class="g-plusone" data-size="medium"></div>
                            <script type="text/javascript">
                                window.___gcfg = {lang: 'en-GB'};

                                (function () {
                                    var po = document.createElement('script');
                                    po.type = 'text/javascript';
                                    po.async = true;
                                    po.src = 'https://apis.google.com/js/plusone.js';
                                    var s = document.getElementsByTagName('script')[0];
                                    s.parentNode.insertBefore(po, s);
                                })();
                            </script>
                        </div>
                        <div class="tw-like-button button-like">
                            <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
                            <script>!function (d, s, id) {
                                    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
                                    if (!d.getElementById(id)) {
                                        js = d.createElement(s);
                                        js.id = id;
                                        js.src = p + '://platform.twitter.com/widgets.js';
                                        fjs.parentNode.insertBefore(js, fjs);
                                    }
                                }(document, 'script', 'twitter-wjs');</script>
                        </div>
                        <div class="all-like-button button-like">
                            <!-- AddThis Button BEGIN -->
                            <div class="addthis_toolbox addthis_default_style">
                                <a class="addthis_counter addthis_pill_style"></a>
                            </div>
                            <script type="text/javascript"
                                    src="//s7.addthis.com/js/300/addthis_widget.js#pubid=undefined"></script>
                            <!-- AddThis Button END -->
                        </div>
                    </div>
                </div>
                <div class="block-footer clearfix">
                    <div class="pull-left m-r-15 tooltip-field"
                         data-title="<?= $this->t('Тип контента'); ?>" data-placement="bottom">
                        <i class="fa fa-filter fa-lg"></i>
                        <?= $this->escape($this->postData['PostCategory']['Name']); ?>
                    </div>
                    <div class="pull-right m-r-15 tooltip-field"
                         data-title="<?= $this->t('Дата создания'); ?>" data-placement="bottom">
                        <i class="fa fa-calendar fa-lg"></i>
                        <?= $this->escape($this->postData['DateCreate']); ?>
                    </div>
                    <?php if ($this->escape($this->postData['DateCreate']) != $this->escape($this->postData['DateEdit'])) : ?>
                        <div class="pull-right m-r-15 tooltip-field"
                             data-title="<?= $this->t('Дата редактирования'); ?>"
                             data-placement="bottom">
                            <i class="fa fa-pencil fa-lg"></i>
                            <?= $this->escape($this->postData['DateEdit']); ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
    <!-- comments -->
    <?php
    $commentAddAccess = $this->checkUserAccess(
        'default' . Acl::RESOURCE_SEPARATOR . 'comment', 'add'
    );
    ?>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="block block-default block-ui-bordered comment-block">
                <div class="block-body">
                    <h4 class="page-header">
                        <i class="fa fa-comments-o fa-lg"></i>
                        <?= $this->t('Комментарии'); ?> ( <?= count($this->postCommentData); ?> )
                    </h4>

                    <div class="comments" id="post-comments">
                        <?php if ($this->postCommentData) { ?>
                            <?php foreach ($this->postCommentData as $comment): ?>
                                <?php
                                // check access and generate link for default/user/id
                                if ($this->checkUserAccess('default' . Acl::RESOURCE_SEPARATOR . 'user', 'id')) {
                                    // TODO: Update user model to Doctrine1
                                    $defaultUserIDUrl = $this->url(
                                        array('module' => 'default', 'controller' => 'user', 'action' => 'id',
                                            'userID' => $this->escape($comment['UserID'])), 'defaultUserID'
                                    );
                                } else {
                                    $defaultUserIDUrl = '#';
                                }
                                ?>

                                <?php
                                $query = Doctrine_Query::create()
                                    ->from('Default_Model_User u')
                                    ->leftJoin('u.UserRole ur')
                                    ->leftJoin('ur.Role r')
                                    ->where('u.ID = ?', $comment['UserID']);

                                $userResult = $query->fetchArray();

                                if ($this->getUser()->getUserStatus($userResult[0]['DateLastActivity']) == USER_STATUS_ONLINE) {
                                    $userStatusClass = 'user-online';
                                } else {
                                    $userStatusClass = 'user-offline';
                                }
                                ?>

                                <div class="message-item" id="m<?= $comment['ID'] ?>">
                                    <div class="message-inner">
                                        <div class="message-head clearfix">
                                            <div class="avatar pull-left">
                                                <div class="block-user">
                                                    <div
                                                        class="img-wrapper-40-40 overflow-hide img-circle center-block user-avatar tooltip-field <?= $userStatusClass; ?>"
                                                        data-title="<?= $userResult[0]['NickName']; ?>"
                                                        data-placement="bottom">
                                                        <a href="<?= $defaultUserIDUrl; ?>" target="_blank">
                                                            <?= $this->getUser()->getUserAvatar(
                                                                $userResult[0]['ID'], $userResult[0]['AvatarType'],
                                                                'media-object img-responsive img-size-40', 40
                                                            ); ?>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="user-detail">
                                                <?php if ($comment['Name']) { ?>
                                                    <h5 class="text-bold handle">
                                                        <?= $comment['Name']; ?>
                                                    </h5>
                                                <?php } ?>
                                                <div class="post-meta">
                                                    <div class="user-meta">
                                                        <span class="qa-message-what"></span>
                                                        <span class="qa-message-who">
                                                            <span class="qa-message-who-pad"> </span>
                                                            <span class="qa-message-who-data">
                                                                <a target="_blank"
                                                                   href="<?= $defaultUserIDUrl; ?>">
                                                                    <?= $userResult[0]['NickName']; ?>
                                                                </a>,
                                                            </span>
                                                        </span>
                                                        <span class="qa-message-when">
                                                            <span class="qa-message-when-data">
                                                                <time><?= $comment['DateCreate']; ?></time>
                                                            </span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="qa-message-content">
                                            <?= $comment['Text']; ?>
                                        </div>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        <?php } else { ?>
                            <div class="alert alert-info">
                                <?= $this->t('Для данной записи нет комментариев! Добавте первым комментарий к этой записе.'); ?>
                            </div>
                        <?php } ?>
                    </div>

                    <?php if ($commentAddAccess) : ?>
                        <hr/>
                        <div id="comment-form-wrapper">
                            <?= $this->commentAddForm; ?>
                        </div>
                    <?php else: ?>
                        <div class="alert alert-info">
                            <?= $this->t(
                                'Чтобы добавить комментарий следует авторизоваться на сайте.'
                            ); ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
    <!-- ./ comments -->
<?php } ?>